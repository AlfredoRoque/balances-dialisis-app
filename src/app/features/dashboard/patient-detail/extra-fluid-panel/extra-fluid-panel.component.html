<section class="extra-fluid-shell">
  <mat-card class="extra-fluid-card">
    <header class="card-head">
      <div>
        <p class="eyebrow">Volúmenes extra</p>
        <h2>Registro de líquidos adicionales</h2>
        <p class="subtitle">Urina e ingesta registrados fuera del balance principal.</p>
      </div>
      <button mat-stroked-button color="accent" type="button" (click)="loadRecords()" [disabled]="loading">
        <mat-icon>refresh</mat-icon>
        Actualizar
      </button>
    </header>

    <section class="table-section" *ngIf="!loading; else loadingState">
      <table mat-table [dataSource]="dataSource" class="extra-table">
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>Fecha</th>
          <td mat-cell *matCellDef="let record">
            <ng-container *ngIf="isEditing(record) && getRowForm(record) as rowForm; else dateView">
              <div class="inline-edit" [formGroup]="rowForm">
                <mat-form-field appearance="outline" class="inline-field">
                  <mat-label>Fecha</mat-label>
                  <input matInput [matDatepicker]="rowPicker" formControlName="date">
                  <mat-datepicker-toggle matIconSuffix [for]="rowPicker"></mat-datepicker-toggle>
                  <mat-datepicker #rowPicker></mat-datepicker>
                  <mat-error *ngIf="rowForm.get('date')?.invalid && rowForm.get('date')?.touched">
                    Selecciona una fecha válida.
                  </mat-error>
                </mat-form-field>
              </div>
            </ng-container>
            <ng-template #dateView>
              {{ formatRecordDate(record.date) }}
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="urine">
          <th mat-header-cell *matHeaderCellDef>Orina (ml)</th>
          <td mat-cell *matCellDef="let record">
            <ng-container *ngIf="isEditing(record) && getRowForm(record) as rowForm; else urineView">
              <div class="inline-edit" [formGroup]="rowForm">
                <mat-form-field appearance="outline" class="inline-field">
                  <mat-label>Orina (ml)</mat-label>
                  <input matInput type="number" min="0" formControlName="urine">
                  <mat-error *ngIf="rowForm.get('urine')?.invalid && rowForm.get('urine')?.touched">
                    Cantidad inválida.
                  </mat-error>
                </mat-form-field>
              </div>
            </ng-container>
            <ng-template #urineView>
              {{ record.urine | number: '1.0-1' }} ml
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="ingested">
          <th mat-header-cell *matHeaderCellDef>Ingerido (ml)</th>
          <td mat-cell *matCellDef="let record">
            <ng-container *ngIf="isEditing(record) && getRowForm(record) as rowForm; else ingestedView">
              <div class="inline-edit" [formGroup]="rowForm">
                <mat-form-field appearance="outline" class="inline-field">
                  <mat-label>Ingerido (ml)</mat-label>
                  <input matInput type="number" min="0" formControlName="ingested">
                  <mat-error *ngIf="rowForm.get('ingested')?.invalid && rowForm.get('ingested')?.touched">
                    Cantidad inválida.
                  </mat-error>
                </mat-form-field>
              </div>
            </ng-container>
            <ng-template #ingestedView>
              {{ record.ingested | number: '1.0-1' }} ml
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="actions-header">Acciones</th>
          <td mat-cell *matCellDef="let record" class="actions-cell">
            <ng-container *ngIf="isEditing(record); else defaultActions">
              <button mat-icon-button color="primary" aria-label="Guardar" (click)="saveRecord(record)"
                      [disabled]="getRowForm(record)?.invalid || savingId === editingId">
                <mat-icon>check</mat-icon>
              </button>
              <button mat-icon-button aria-label="Cancelar" (click)="cancelEdit(record)" [disabled]="savingId === editingId">
                <mat-icon>close</mat-icon>
              </button>
            </ng-container>
            <ng-template #defaultActions>
              <button mat-icon-button color="primary" aria-label="Editar" (click)="startEdit(record)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" aria-label="Eliminar" (click)="deleteRecord(record)">
                <mat-icon>delete</mat-icon>
              </button>
            </ng-template>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
      <mat-paginator [pageSize]="5" [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
    </section>

    <ng-template #loadingState>
      <div class="loading-state">
        <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
        <p>Cargando registros...</p>
      </div>
    </ng-template>

    <mat-divider></mat-divider>

    <section class="create-section">
      <header>
        <h3>Agregar extra fluid</h3>
        <p>Registra nuevas mediciones de orina e ingesta.</p>
      </header>
      <form [formGroup]="createForm" (ngSubmit)= "submitCreate()">
        <mat-form-field appearance="outline">
          <mat-label class="input-label">Fecha</mat-label>
          <input matInput [matDatepicker]="createPicker" formControlName="date" class="input-content">
          <mat-datepicker-toggle matIconSuffix [for]="createPicker"></mat-datepicker-toggle>
          <mat-datepicker #createPicker></mat-datepicker>
          <mat-error *ngIf="createForm.get('date')?.invalid && createForm.get('date')?.touched">
            Selecciona una fecha válida.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label class="input-label">Orina (ml)</mat-label>
          <input matInput type="number" min="0" formControlName="urine" class="input-content">
          <mat-error *ngIf="createForm.get('urine')?.invalid && createForm.get('urine')?.touched">
            Cantidad inválida.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label class="input-label">Ingerido (ml)</mat-label>
          <input matInput type="number" min="0" formControlName="ingested" class="input-content">
          <mat-error *ngIf="createForm.get('ingested')?.invalid && createForm.get('ingested')?.touched">
            Cantidad inválida.
          </mat-error>
        </mat-form-field>

        <div class="form-actions">
          <button mat-stroked-button type="button" (click)="createForm.reset()">
            Limpiar
          </button>
          <button mat-flat-button color="primary" type="submit" [disabled]="createForm.invalid || creating">
            {{ creating ? 'Guardando...' : 'Agregar registro' }}
          </button>
        </div>
      </form>
    </section>
  </mat-card>
</section>
