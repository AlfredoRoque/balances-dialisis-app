<section class="detail-shell">
  <mat-card class="detail-card">
    <header class="detail-header">
      <div>
        <p class="eyebrow">Detalle del paciente</p>
        <h1>{{ patientLabel }} · ID {{ patientId }}</h1>
        <p class="subtitle">Consulta, registra y administra los balances de fluidos.</p>
      </div>
      <div class="header-actions">
        <button mat-stroked-button color="accent" type="button" (click)="goBack()">
          <mat-icon>arrow_back</mat-icon>
          Volver al dashboard
        </button>
        <app-logout-button></app-logout-button>
      </div>
    </header>

    <section class="filters">
      <form class="filter-form" [formGroup]="filterForm" (ngSubmit)="applyDateFilter()">
        <mat-form-field appearance="outline">
          <mat-label class="input-label">Desde</mat-label >
          <input matInput [matDatepicker]="startPicker" formControlName="startDate" class="input-content">
          <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
          <mat-error *ngIf="filterForm.get('startDate')?.touched && filterForm.get('startDate')?.invalid">
            Ingresa una fecha válida.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label class="input-label">Hasta</mat-label>
          <input matInput [matDatepicker]="endPicker" formControlName="endDate" class="input-content">
          <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
          <mat-error *ngIf="filterForm.get('endDate')?.touched && filterForm.get('endDate')?.invalid">
            Ingresa una fecha válida.
          </mat-error>
        </mat-form-field>

        <div class="filter-actions">
          <button mat-flat-button color="primary" type="submit">Filtrar</button>
          <button mat-stroked-button type="button" (click)="clearDateFilter()">Limpiar</button>
        </div>
      </form>
    </section>

    <section class="table-section" *ngIf="!loading; else loadingState">
      <div class="table-actions">
        <button mat-stroked-button color="accent" type="button" (click)="goToCalculatedBalance()">
          <mat-icon>analytics</mat-icon>
          Ver balance calculado
        </button>
      </div>
      <table mat-table [dataSource]="dataSource" class="balances-table">
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>Fecha</th>
          <td mat-cell *matCellDef="let balance">
            <ng-container *ngIf="isEditingBalance(balance); else dateView">
              <div class="inline-edit" [formGroup]="editForm">
                <mat-form-field appearance="outline" class="inline-field">
                  <mat-label>Horario activo</mat-label>
                  <mat-select formControlName="date" [disabled]="!editFormSlots.length">
                    <mat-option *ngFor="let slot of editFormSlots" [value]="slot.date">
                      {{ slot.label }}
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="editForm.get('date')?.invalid && editForm.get('date')?.touched">
                    Selecciona un horario válido.
                  </mat-error>
                  <mat-error *ngIf="editForm.get('date')?.hasError('inactiveDate')">
                    Usa uno de los horarios habilitados para esta fecha.
                  </mat-error>
                </mat-form-field>
              </div>
            </ng-container>
            <ng-template #dateView>
              {{ formatBalanceDate24(balance.date) }}
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>Descripción</th>
          <td mat-cell *matCellDef="let balance">
            <ng-container *ngIf="isEditingBalance(balance); else descriptionView">
              <div class="inline-edit" [formGroup]="editForm">
                <mat-form-field appearance="outline" class="inline-field full">
                  <mat-label>Descripción</mat-label>
                  <textarea matInput rows="2" formControlName="descriptionFluid"></textarea>
                </mat-form-field>
              </div>
            </ng-container>
            <ng-template #descriptionView>
              {{ balance.descriptionFluid || 'Sin descripción' }}
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="infused">
          <th mat-header-cell *matHeaderCellDef>Infundido</th>
          <td mat-cell *matCellDef="let balance">
            <ng-container *ngIf="isEditingBalance(balance); else infusedView">
              <div class="inline-edit" [formGroup]="editForm">
                <mat-form-field appearance="outline" class="inline-field">
                  <mat-label>Infundido (ml)</mat-label>
                  <input matInput type="number" formControlName="infused" min="0">
                  <mat-error *ngIf="editForm.get('infused')?.invalid && editForm.get('infused')?.touched">
                    Cantidad inválida.
                  </mat-error>
                </mat-form-field>
              </div>
            </ng-container>
            <ng-template #infusedView>
              {{ balance.infused | number: '1.0-1' }} ml
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="drained">
          <th mat-header-cell *matHeaderCellDef>Drenado</th>
          <td mat-cell *matCellDef="let balance">
            <ng-container *ngIf="isEditingBalance(balance); else drainedView">
              <div class="inline-edit" [formGroup]="editForm">
                <mat-form-field appearance="outline" class="inline-field">
                  <mat-label>Drenado (ml)</mat-label>
                  <input matInput type="number" formControlName="drained" min="0">
                  <mat-error *ngIf="editForm.get('drained')?.invalid && editForm.get('drained')?.touched">
                    Cantidad inválida.
                  </mat-error>
                </mat-form-field>
              </div>
            </ng-container>
            <ng-template #drainedView>
              {{ balance.drained | number: '1.0-1' }} ml
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="actions-header">Acciones</th>
          <td mat-cell *matCellDef="let balance" class="actions-cell">
            <ng-container *ngIf="isEditingBalance(balance); else defaultBalanceActions">
              <button mat-icon-button color="primary" (click)="submitEdit()" [disabled]="editForm.invalid || savingBalanceId === editingBalanceId">
                <mat-icon>check</mat-icon>
              </button>
              <button mat-icon-button (click)="cancelEdit()" [disabled]="savingBalanceId === editingBalanceId">
                <mat-icon>close</mat-icon>
              </button>
            </ng-container>
            <ng-template #defaultBalanceActions>
              <button mat-icon-button color="primary" (click)="startEdit(balance)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="deleteBalance(balance)">
                <mat-icon>delete</mat-icon>
              </button>
            </ng-template>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; let i = index; columns: displayedColumns;"
            [class.date-divider]="shouldShowDateDivider(i)"></tr>
      </table>
      <mat-paginator [pageSize]="10" [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
    </section>

    <ng-template #loadingState>
      <div class="loading-state">
        <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
        <p>Cargando balances...</p>
      </div>
    </ng-template>

    <mat-divider></mat-divider>

    <section class="create-section">
      <h3>Registrar balance</h3>
      <form [formGroup]="createForm" (ngSubmit)="submitCreate()">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label class="input-label">Horario activo</mat-label>
          <mat-select formControlName="date" placeholder="Selecciona un horario"
                      [disabled]="activeDatesLoading || !hasActiveDates" class="input-content">
            <mat-option *ngIf="activeDatesLoading" disabled>Cargando horarios...</mat-option>
            <mat-option *ngFor="let slot of activeSlots" [value]="slot.date">
              {{ slot.label }}
            </mat-option>
          </mat-select>
          <mat-hint *ngIf="!activeDatesLoading && hasActiveDates" align="start">
            Usa una de las horas habilitadas para hoy.
          </mat-hint>
          <mat-hint *ngIf="!activeDatesLoading && !hasActiveDates" align="start">
            No hay horarios activos disponibles.
          </mat-hint>
          <mat-error *ngIf="createForm.get('date')?.hasError('required') && createForm.get('date')?.touched">
            Selecciona un horario.
          </mat-error>
          <mat-error *ngIf="createForm.get('date')?.hasError('inactiveDate')">
            Utiliza uno de los horarios disponibles.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label class="input-label">Infundido (ml)</mat-label>
          <input matInput type="number" formControlName="infused" min="0" class="input-content">
          <mat-error *ngIf="createForm.get('infused')?.invalid && createForm.get('infused')?.touched">
            Cantidad inválida.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label class="input-label">Drenado (ml)</mat-label>
          <input matInput type="number" formControlName="drained" min="0" class="input-content">
          <mat-error *ngIf="createForm.get('drained')?.invalid && createForm.get('drained')?.touched">
            Cantidad inválida.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label class="input-label">Descripción</mat-label>
          <textarea matInput rows="2" formControlName="descriptionFluid" class="input-content"></textarea>
        </mat-form-field>

        <p class="active-dates-warning" *ngIf="!activeDatesLoading && !hasActiveDates">
          No hay horarios activos disponibles para registrar balances.
        </p>

        <div class="form-actions">
          <button mat-stroked-button type="button" (click)="createForm.reset()">Limpiar</button>
          <button mat-flat-button color="primary" type="submit" [disabled]="createForm.invalid || creating || !hasActiveDates">
            <mat-icon>add</mat-icon>
            {{ creating ? 'Guardando...' : 'Agregar balance' }}
          </button>
        </div>
      </form>
    </section>
  </mat-card>

  <app-extra-fluid-panel
    [patientId]="patientId"
    [filterStart]="filterForm.get('startDate')?.value"
    [filterEnd]="filterForm.get('endDate')?.value">
  </app-extra-fluid-panel>

  <app-vital-sign-detail-panel
    [patientId]="patientId"
    [filterStart]="filterForm.get('startDate')?.value"
    [filterEnd]="filterForm.get('endDate')?.value">
  </app-vital-sign-detail-panel>

  <app-medicine-detail-panel [patientId]="patientId"></app-medicine-detail-panel>
</section>
