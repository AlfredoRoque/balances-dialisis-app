<section class="medicine-shell">
  <mat-card class="medicine-card">
    <header class="card-head">
      <div>
        <p class="eyebrow">Medicamentos</p>
        <h2>Tratamientos administrados</h2>
        <p class="subtitle">Registra dosis y frecuencias aplicadas al paciente.</p>
      </div>
      <button mat-stroked-button color="accent" type="button" (click)="loadRecords()" [disabled]="loading">
        <mat-icon>refresh</mat-icon>
        Actualizar
      </button>
    </header>

    <section class="table-section" *ngIf="!loading; else loadingState">
      <table mat-table [dataSource]="dataSource" class="medicine-table">
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>Fecha</th>
          <td mat-cell *matCellDef="let record">
            <ng-container *ngIf="isEditing(record) && getRowForm(record) as rowForm; else dateView">
              <div class="inline-edit" [formGroup]="rowForm">
                <mat-form-field appearance="outline" class="inline-field">
                  <mat-label>Fecha</mat-label>
                  <input matInput [matDatepicker]="rowPicker" formControlName="date">
                  <mat-datepicker-toggle matIconSuffix [for]="rowPicker"></mat-datepicker-toggle>
                  <mat-datepicker #rowPicker></mat-datepicker>
                  <mat-error *ngIf="rowForm.get('date')?.invalid && rowForm.get('date')?.touched">
                    Selecciona una fecha válida.
                  </mat-error>
                </mat-form-field>
              </div>
            </ng-container>
            <ng-template #dateView>
              {{ formatRecordDate(record.date) }}
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="medicine">
          <th mat-header-cell *matHeaderCellDef>Medicamento</th>
          <td mat-cell *matCellDef="let record">
            <ng-container *ngIf="isEditing(record) && getRowForm(record) as rowForm; else medicineView">
              <div class="inline-edit" [formGroup]="rowForm">
                <mat-form-field appearance="outline" class="inline-field">
                  <mat-label>Medicamento</mat-label>
                  <mat-select formControlName="medicineId" [disabled]="medicinesLoading || !medicines.length">
                    <mat-option *ngIf="medicinesLoading" disabled>Cargando medicamentos...</mat-option>
                    <mat-option *ngFor="let med of medicines" [value]="med.id">{{ med.name }}</mat-option>
                  </mat-select>
                  <mat-error *ngIf="rowForm.get('medicineId')?.invalid && rowForm.get('medicineId')?.touched">
                    Selecciona un medicamento.
                  </mat-error>
                </mat-form-field>
              </div>
            </ng-container>
            <ng-template #medicineView>
              {{ getMedicineLabel(record) }}
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="dose">
          <th mat-header-cell *matHeaderCellDef>Dosis</th>
          <td mat-cell *matCellDef="let record">
            <ng-container *ngIf="isEditing(record) && getRowForm(record) as rowForm; else doseView">
              <div class="inline-edit" [formGroup]="rowForm">
                <mat-form-field appearance="outline" class="inline-field">
                  <mat-label>Dosis</mat-label>
                  <input matInput formControlName="dose" maxlength="120">
                  <mat-error *ngIf="rowForm.get('dose')?.invalid && rowForm.get('dose')?.touched">
                    Ingresa una dosis válida.
                  </mat-error>
                </mat-form-field>
              </div>
            </ng-container>
            <ng-template #doseView>
              {{ record.dose || 'Sin dosis' }}
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="frequency">
          <th mat-header-cell *matHeaderCellDef>Frecuencia</th>
          <td mat-cell *matCellDef="let record">
            <ng-container *ngIf="isEditing(record) && getRowForm(record) as rowForm; else frequencyView">
              <div class="inline-edit" [formGroup]="rowForm">
                <mat-form-field appearance="outline" class="inline-field">
                  <mat-label>Frecuencia</mat-label>
                  <input matInput formControlName="frequency" maxlength="120">
                  <mat-error *ngIf="rowForm.get('frequency')?.invalid && rowForm.get('frequency')?.touched">
                    Ingresa una frecuencia válida.
                  </mat-error>
                </mat-form-field>
              </div>
            </ng-container>
            <ng-template #frequencyView>
              {{ record.frequency || 'Sin frecuencia' }}
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="actions-header">Acciones</th>
          <td mat-cell *matCellDef="let record" class="actions-cell">
            <ng-container *ngIf="isEditing(record); else defaultActions">
              <button mat-icon-button color="primary" aria-label="Guardar" (click)="saveRecord(record)"
                      [disabled]="getRowForm(record)?.invalid || savingId === editingId">
                <mat-icon>check</mat-icon>
              </button>
              <button mat-icon-button aria-label="Cancelar" (click)="cancelEdit(record)" [disabled]="savingId === editingId">
                <mat-icon>close</mat-icon>
              </button>
            </ng-container>
            <ng-template #defaultActions>
              <button mat-icon-button color="primary" aria-label="Editar" (click)="startEdit(record)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" aria-label="Eliminar" (click)="deleteRecord(record)">
                <mat-icon>delete</mat-icon>
              </button>
            </ng-template>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
      <mat-paginator [pageSize]="5" [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
    </section>

    <ng-template #loadingState>
      <div class="loading-state">
        <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
        <p>Cargando registros...</p>
      </div>
    </ng-template>

    <mat-divider></mat-divider>

    <section class="create-section">
      <header>
        <h3>Agregar medicamento</h3>
        <p>Captura una nueva administración.</p>
      </header>
      <form [formGroup]="createForm" (ngSubmit)="submitCreate()">
        <mat-form-field appearance="outline">
          <mat-label class="input-label">Fecha</mat-label>
          <input matInput [matDatepicker]="createPicker" formControlName="date" class="input-content">
          <mat-datepicker-toggle matIconSuffix [for]="createPicker"></mat-datepicker-toggle>
          <mat-datepicker #createPicker></mat-datepicker>
          <mat-error *ngIf="createForm.get('date')?.invalid && createForm.get('date')?.touched">
            Selecciona una fecha válida.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label class="input-label">Medicamento</mat-label>
          <mat-select formControlName="medicineId" [disabled]="medicinesLoading || !medicines.length" class="input-content">
            <mat-option *ngIf="medicinesLoading" disabled>Cargando medicamentos...</mat-option>
            <mat-option *ngFor="let med of medicines" [value]="med.id">{{ med.name }}</mat-option>
          </mat-select>
          <mat-error *ngIf="createForm.get('medicineId')?.invalid && createForm.get('medicineId')?.touched">
            Selecciona un medicamento.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label class="input-label">Dosis</mat-label>
          <input matInput formControlName="dose" maxlength="120" class="input-content">
          <mat-error *ngIf="createForm.get('dose')?.invalid && createForm.get('dose')?.touched">
            Ingresa una dosis válida.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label class="input-label">Frecuencia</mat-label>
          <input matInput formControlName="frequency" maxlength="120" class="input-content">
          <mat-error *ngIf="createForm.get('frequency')?.invalid && createForm.get('frequency')?.touched">
            Ingresa una frecuencia válida.
          </mat-error>
        </mat-form-field>

        <p class="no-medicines" *ngIf="!medicinesLoading && !medicines.length">
          Agrega medicamentos en el módulo correspondiente para habilitar esta sección.
        </p>

        <div class="form-actions">
          <button mat-stroked-button type="button" (click)="resetCreateForm()">
            Limpiar
          </button>
          <button mat-flat-button color="primary" type="submit" [disabled]="createForm.invalid || creating || !medicines.length">
            {{ creating ? 'Guardando...' : 'Agregar registro' }}
          </button>
        </div>
      </form>
    </section>
  </mat-card>
</section>
