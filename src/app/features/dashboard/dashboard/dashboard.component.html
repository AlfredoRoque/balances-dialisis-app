<section class="dashboard-shell">
  <header class="page-header">
    <div>
      <p class="eyebrow">Inicio</p>
      <h1>Panel de pacientes</h1>
      <p class="subtitle">Monitorea el estado de las sesiones y gestiona tu cohorte activa.</p>
    </div>
    <button mat-stroked-button color="accent" (click)="logout()">Cerrar sesión</button>
  </header>

  <mat-card class="patients-card">
    <div class="card-head">
      <div>
        <h2>Pacientes en seguimiento</h2>
        <p>{{ dataSource.data.length }} registros totales</p>
      </div>
    </div>

    <div class="table-wrapper">
      <table mat-table [dataSource]="dataSource" class="patients-table">
        <ng-container matColumnDef="patient">
          <th mat-header-cell *matHeaderCellDef>Paciente</th>
          <td mat-cell *matCellDef="let patient">
            <ng-container *ngIf="isEditing(patient.id); else patientView">
              <div class="inline-edit" [formGroup]="rowForms[patient.id]">
                <mat-form-field appearance="outline" class="inline-field">
                  <mat-label>Nombre</mat-label>
                  <input matInput formControlName="name" placeholder="Nombre completo">
                  <mat-error *ngIf="rowForms[patient.id]?.get('name')?.invalid && rowForms[patient.id]?.get('name')?.touched">
                    Ingresa un nombre válido.
                  </mat-error>
                </mat-form-field>
              </div>
            </ng-container>
            <ng-template #patientView>
              <div class="cell-main">
                <span class="name">{{ patient.name }}</span>
              </div>
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="age">
          <th mat-header-cell *matHeaderCellDef>Edad</th>
          <td mat-cell *matCellDef="let patient">
            <ng-container *ngIf="isEditing(patient.id); else ageView">
              <div class="inline-edit" [formGroup]="rowForms[patient.id]">
                <mat-form-field appearance="outline" class="inline-field">
                  <mat-label>Edad</mat-label>
                  <input matInput type="number" formControlName="age" min="0" max="120">
                  <mat-error *ngIf="rowForms[patient.id]?.get('age')?.invalid && rowForms[patient.id]?.get('age')?.touched">
                    Ingresa una edad válida.
                  </mat-error>
                </mat-form-field>
              </div>
            </ng-container>
            <ng-template #ageView>
              {{ patient.age }} años
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="bagType">
          <th mat-header-cell *matHeaderCellDef>Tipo de bolsa</th>
          <td mat-cell *matCellDef="let patient">
            <ng-container *ngIf="isEditing(patient.id); else bagTypeView">
              <div class="inline-edit" [formGroup]="rowForms[patient.id]">
                <mat-form-field appearance="outline" class="inline-field">
                  <mat-label>Tipo de bolsa</mat-label>
                  <mat-select formControlName="bagTypeId" [disabled]="bagTypesLoading || !bagTypes.length">
                    <mat-option *ngFor="let bag of bagTypes" [value]="bag.id">
                      {{ bag.type }} {{ bag.description ? '- ' + bag.description : '' }}
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="rowForms[patient.id]?.get('bagTypeId')?.invalid && rowForms[patient.id]?.get('bagTypeId')?.touched">
                    Selecciona un tipo de bolsa.
                  </mat-error>
                </mat-form-field>
              </div>
            </ng-container>
            <ng-template #bagTypeView>
              {{ patient.bagType?.type || 'Sin asignar' }} {{ patient.bagType?.description ? '- ' + patient.bagType.description : '' }}
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="actions-header">Acciones</th>
          <td mat-cell *matCellDef="let patient" class="actions-cell">
            <ng-container *ngIf="isEditing(patient.id); else defaultActions">
              <button mat-icon-button color="primary" aria-label="Guardar cambios" (click)="savePatient(patient)" [disabled]="savingPatientId === patient.id">
                <mat-icon>check</mat-icon>
              </button>
              <button mat-icon-button aria-label="Cancelar edición" (click)="cancelEdit(patient)" [disabled]="savingPatientId === patient.id">
                <mat-icon>close</mat-icon>
              </button>
            </ng-container>
            <ng-template #defaultActions>
              <button mat-icon-button color="primary" aria-label="Editar paciente" (click)="startEdit(patient)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" aria-label="Eliminar paciente" (click)="deletePatient(patient)">
                <mat-icon>delete</mat-icon>
              </button>
            </ng-template>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>

    <mat-paginator [pageSize]="10" [pageSizeOptions]="[10]" showFirstLastButtons></mat-paginator>

    <section class="card-footer">
      <div class="footer-info">
        <h3>Agregar paciente</h3>
        <p>Registra nuevas personas cuando se incorporen a tu unidad.</p>
      </div>

      <form class="new-patient-form" [formGroup]="newPatientForm" (ngSubmit)="addPatient()">
        <mat-form-field appearance="outline">
          <mat-label>Nombre completo</mat-label>
          <input matInput formControlName="name" placeholder="Ej. Ana Pérez">
          <mat-error *ngIf="newPatientForm.get('name')?.invalid && newPatientForm.get('name')?.touched">
            Ingresa un nombre válido.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Edad</mat-label>
          <input matInput type="number" formControlName="age" min="0" max="120">
          <mat-error *ngIf="newPatientForm.get('age')?.invalid && newPatientForm.get('age')?.touched">
            Ingresa una edad válida.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Tipo de bolsa</mat-label>
          <mat-select formControlName="bagTypeId" [disabled]="bagTypesLoading || !bagTypes.length">
            <mat-option *ngFor="let bag of bagTypes" [value]="bag.id">
              {{ bag.type }} {{ bag.description ? '- ' + bag.description : '' }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="newPatientForm.get('bagTypeId')?.invalid && newPatientForm.get('bagTypeId')?.touched">
            Selecciona un tipo de bolsa.
          </mat-error>
        </mat-form-field>

        <button mat-flat-button color="primary" type="submit" [disabled]="newPatientForm.invalid || creatingPatient">
          {{ creatingPatient ? 'Guardando...' : 'Registrar paciente' }}
        </button>
      </form>
    </section>
  </mat-card>
</section>
